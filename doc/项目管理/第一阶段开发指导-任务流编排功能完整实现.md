# 第一阶段开发指导：任务流编排功能完整实现

## 开发目标

基于现有的`TrainingStagePanel`、`TaskTypeSelector`和`TaskList`组件，完善任务流编排的核心功能，提升用户体验和功能完整性。

## 当前状况分析

### ✅ 已完成功能
- ✅ 基础阶段管理（增删改查）
- ✅ 任务类型分组展示（online/offline/tool）
- ✅ 任务创建和基本编辑
- ✅ 任务编辑注册表机制
- ✅ 基础的任务列表展示

### 🔄 需要优化的功能
- 🔄 任务拖拽排序
- 🔄 任务批量操作
- 🔄 阶段间任务移动
- 🔄 任务类型元数据管理
- 🔄 阶段模板功能

## 开发任务清单

### Week 1-2: 任务类型管理优化

#### 任务1.1: 增强任务类型定义
**目标**: 为`taskTypeCategories.ts`添加更丰富的元数据

```typescript
// 修改 training-system-frontend/src/modules/project-management/constants/taskTypeCategories.ts
export interface TaskTypeConfig {
  type: string;
  label: string;
  icon: Component;
  color: string;
  category: 'online' | 'offline' | 'tool';
  description?: string;
  defaultConfig?: Record<string, any>;
  estimatedDuration?: number; // 预估时长（分钟）
}

export const ENHANCED_TASK_TYPES: TaskTypeConfig[] = [
  {
    type: 'face-to-face',
    label: '面授',
    icon: User,
    color: '#409EFF',
    category: 'offline',
    description: '线下面授课程',
    defaultConfig: { duration: 120 },
    estimatedDuration: 120
  },
  // ... 其他任务类型
];
```

#### 任务1.2: 动态图标和颜色管理
**目标**: 将图标映射从组件中提取到配置文件

```typescript
// 新建文件: constants/taskTypeIcons.ts
import { User, Edit, Reading, Timer } from '@element-plus/icons-vue';

export const TASK_TYPE_ICONS: Record<string, any> = {
  'face-to-face': User,
  'homework': Edit,
  'online-course': Reading,
  'attendance': Timer,
  // ... 其他图标映射
};

export const TASK_TYPE_COLORS: Record<string, string> = {
  'face-to-face': '#409EFF',
  'homework': '#67C23A',
  'online-course': '#E6A23C',
  'attendance': '#F56C6C',
};
```

### Week 3-4: 任务流编辑器增强

#### 任务2.1: 实现任务拖拽排序
**目标**: 在`TaskList.vue`中实现任务的拖拽排序功能

```vue
<!-- 修改 TaskList.vue -->
<template>
  <el-table 
    :data="filteredTasks" 
    border 
    stripe 
    size="small"
    row-key="id"
    @row-drop="handleTaskReorder"
  >
    <!-- 现有列... -->
  </el-table>
</template>

<script setup lang="ts">
import Sortable from 'sortablejs';

// 添加拖拽排序功能
function handleTaskReorder(evt: any) {
  const { oldIndex, newIndex } = evt;
  if (!currentStage.value) return;
  
  const tasks = currentStage.value.tasks;
  const [movedTask] = tasks.splice(oldIndex, 1);
  tasks.splice(newIndex, 0, movedTask);
  
  // 更新order字段
  tasks.forEach((task, index) => {
    task.order = index;
  });
}
</script>
```

#### 任务2.2: 任务批量操作功能
**目标**: 添加任务的批量选择、删除、移动功能

```vue
<!-- 在 TaskList.vue 中添加批量操作 -->
<template>
  <div class="task-list">
    <!-- 批量操作工具栏 -->
    <div v-if="selectedTasks.length > 0" class="batch-toolbar">
      <el-button size="small" @click="batchDelete">批量删除</el-button>
      <el-button size="small" @click="batchMove">批量移动</el-button>
      <el-button size="small" @click="batchCopy">批量复制</el-button>
    </div>
    
    <el-table 
      :data="filteredTasks"
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" width="55" />
      <!-- 其他列... -->
    </el-table>
  </div>
</template>
```

### Week 5-6: 阶段管理完善

#### 任务3.1: 阶段间任务移动
**目标**: 实现任务在不同阶段间的移动和复制

```typescript
// 在 trainingStage.ts 中添加新方法
function moveTaskBetweenStages(taskId: string, fromStageId: string, toStageId: string) {
  const fromStage = stages.value.find(s => s.id === fromStageId);
  const toStage = stages.value.find(s => s.id === toStageId);
  
  if (!fromStage || !toStage) return;
  
  const taskIndex = fromStage.tasks.findIndex(t => t.id === taskId);
  if (taskIndex === -1) return;
  
  const [task] = fromStage.tasks.splice(taskIndex, 1);
  task.order = toStage.tasks.length;
  toStage.tasks.push(task);
}

function duplicateTask(taskId: string) {
  const task = findTaskById(taskId);
  if (!task) return;
  
  const newTask: Task = {
    ...task,
    id: nanoid(),
    name: `${task.name} (副本)`,
    order: task.order + 1
  };
  
  addTaskToStage(newTask, activeStageId.value);
}
```

#### 任务3.2: 阶段模板功能
**目标**: 允许用户保存和应用阶段模板

```typescript
// 新建文件: types/stageTemplate.ts
export interface StageTemplate {
  id: string;
  name: string;
  description?: string;
  tasks: Omit<Task, 'id'>[];
  category: 'default' | 'custom';
}

// 在 trainingStage.ts 中添加模板相关方法
function saveStageAsTemplate(stageId: string, templateName: string) {
  const stage = stages.value.find(s => s.id === stageId);
  if (!stage) return;
  
  const template: StageTemplate = {
    id: nanoid(),
    name: templateName,
    tasks: stage.tasks.map(({ id, ...task }) => task),
    category: 'custom'
  };
  
  // 保存到本地存储或发送到后端
  saveTemplate(template);
}

function applyTemplate(templateId: string, targetStageId?: string) {
  const template = getTemplateById(templateId);
  if (!template) return;
  
  const stageId = targetStageId || activeStageId.value;
  const stage = stages.value.find(s => s.id === stageId);
  if (!stage) return;
  
  // 清空现有任务并应用模板
  stage.tasks = template.tasks.map(task => ({
    ...task,
    id: nanoid()
  }));
}
```

## 实现优先级

1. **高优先级（必须完成）**
   - 任务拖拽排序
   - 任务批量操作
   - 增强的任务类型定义

2. **中优先级（建议完成）**
   - 阶段间任务移动
   - 动态图标和颜色管理

3. **低优先级（时间允许时完成）**
   - 阶段模板功能
   - 任务统计和分析

## 技术要点

### 拖拽实现
- 使用`sortablejs`库实现表格行的拖拽
- 确保拖拽后正确更新任务的`order`字段
- 提供拖拽时的视觉反馈

### 状态管理
- 所有操作都要同步更新Store中的数据
- 考虑添加操作历史记录以支持撤销功能
- 保持数据的一致性和完整性

### 用户体验
- 操作确认：删除、移动等重要操作需要用户确认
- 加载状态：批量操作时显示进度指示器
- 错误处理：操作失败时给出明确的错误提示

## 测试计划

1. **功能测试**
   - 拖拽排序功能的准确性
   - 批量操作的正确性
   - 阶段间移动的数据完整性

2. **用户体验测试**
   - 操作的直观性和易用性
   - 响应速度和性能
   - 错误处理的友好性

3. **兼容性测试**
   - 不同浏览器的兼容性
   - 移动端的触摸操作支持

## 后续集成

完成本阶段后，需要：
1. 与后端API集成，持久化任务流数据
2. 添加任务流的版本控制功能
3. 实现任务流的导入导出功能
4. 为下一阶段的面授、作业、线上课程界面开发做好准备

---

*开发周期：4-6周*  
*负责人：前端开发团队*  
*评审时间：每周五下午* 